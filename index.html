<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Supershop Bisagno S.R.L. - Articoli Regalo, Giocattoli, Casalinghi Genova</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Supershop Bisagno S.R.L. - Articoli regalo, giocattoli, cartoleria, casalinghi, ferramenta a Genova. Dal 2019 il vostro punto di riferimento.">
<meta name="keywords" content="supershop bisagno, genova, articoli regalo, giocattoli, casalinghi, ferramenta, natale">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõçÔ∏è</text></svg>">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ‰Ω†ÁöÑ Firebase ÈÖçÁΩÆ
  const firebaseConfig = {
    apiKey: "AIzaSyA-cfBzR8BIFwYqoTk3dUo2uXHkw-c8rPU",
    authDomain: "supershop-bisagno.firebaseapp.com",
    projectId: "supershop-bisagno",
    storageBucket: "supershop-bisagno.firebasestorage.app",
    messagingSenderId: "381483524192",
    appId: "1:381483524192:web:ac657@bbd5725719e2e385"
  };

  // ÂàùÂßãÂåñ Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ËÆæÁΩÆ‰∏∫ÂÖ®Â±ÄÂèòÈáè
  window.firebaseApp = app;
  window.firestore = db;
  window.firebaseModules = { collection, getDocs, addDoc, doc, updateDoc, deleteDoc };
  
  console.log("Firebase inizializzato con successo");
<script>
// ==================== Âä®ÊÄÅÂØÜÁ†ÅÁ≥ªÁªü ====================
const DYNAMIC_PASSWORD_CONFIG = {
  ENABLED: true,
  BASE_PASSWORD: 'supershop',
  STATIC_PASSWORDS: ['admin123', 'bisagno2024'],
  PASSWORD_VALIDITY_HOURS: 24
};

function generateDynamicPassword() {
  const today = new Date();
  return DYNAMIC_PASSWORD_CONFIG.BASE_PASSWORD + today.getDate().toString().padStart(2, '0') + (today.getMonth() + 1).toString().padStart(2, '0');
}

function validateAdminPassword(inputPassword) {
  const dynamicPassword = generateDynamicPassword();
  return inputPassword === dynamicPassword || DYNAMIC_PASSWORD_CONFIG.STATIC_PASSWORDS.includes(inputPassword);
}

// ==================== ‰∫ßÂìÅÊï∞ÊçÆ ====================
// Ê£ÄÊü•ÂèòÈáèÂÜ≤Á™ÅÂπ∂ÂàùÂßãÂåñ
console.log("üîß ÂàùÂßãÂåñ‰∫ßÂìÅÂ≠òÂÇ®...");
if (window.products && typeof window.products === 'object' && window.products.nodeType) {
    console.log("‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂèòÈáèÂÜ≤Á™ÅÔºå‰ΩøÁî® storeProducts");
    window.storeProducts = [];
} else {
    window.storeProducts = window.products || [];
}
console.log("ÂàùÂßãÂåñÂÆåÊàê:", window.storeProducts);

// ==================== Â∑•ÂÖ∑ÂáΩÊï∞ ====================
const saveStorage = (key,val) => { 
  try { 
    localStorage.setItem(key,JSON.stringify(val)); 
  } catch(e) {
    console.error('Errore nel salvataggio:', e);
  } 
};

const loadStorage = key => { 
  try { 
    return JSON.parse(localStorage.getItem(key)); 
  } catch(e) { 
    console.error('Errore nel caricamento:', e);
    return null; 
  } 
};

const showSyncStatus = (msg,type='success') => {
  const s = document.getElementById('sync-status'); 
  const t = document.getElementById('sync-text');
  t.textContent = msg; 
  s.className = 'sync-status ' + type; 
  s.style.display = 'flex';
  setTimeout(()=>s.style.display='none',3000);
};

// ==================== Firebase ÂäüËÉΩ ====================
// Ëá™Âä®ÂàùÂßãÂåñÊï∞ÊçÆÂ∫ìÔºàÂ¶ÇÊûú‰∏∫Á©∫Ôºâ
async function initializeFirebaseData() {
  try {
    const { collection, getDocs, addDoc } = window.firebaseModules;
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÊï∞ÊçÆ
    const querySnapshot = await getDocs(collection(window.firestore, "products"));
    console.log("ÂΩìÂâç‰∫ßÂìÅÊï∞Èáè:", querySnapshot.size);
    
    // Â¶ÇÊûúÊï∞ÊçÆÂ∫ì‰∏∫Á©∫ÔºåÂàõÂª∫ÊµãËØïÊï∞ÊçÆ
    if (querySnapshot.size === 0) {
      console.log("üîÑ ÂàùÂßãÂåñÊµãËØïÊï∞ÊçÆ...");
      
      const testProducts = [
        {
          id: "TEST001",
          name: "Prodotto di Test - Articolo Regalo",
          category: "regalo",
          price: "‚Ç¨15,00",
          description: "Prodotto di test per verificare il funzionamento del sistema",
          image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UHJvZG90dG8gZGUgdGVzdDwvdGV4dD48L3N2Zz4=",
          createdAt: new Date().toISOString()
        }
      ];
      
      // ÊâπÈáèÊ∑ªÂä†ÊµãËØï‰∫ßÂìÅ
      for (const product of testProducts) {
        await addDoc(collection(window.firestore, "products"), product);
        console.log("‚úÖ Ê∑ªÂä†‰∫ßÂìÅ:", product.name);
      }
      
      console.log("üéâ ÂàùÂßãÂåñÂÆåÊàêÔºÅÊ∑ªÂä†‰∫Ü", testProducts.length, "‰∏™ÊµãËØï‰∫ßÂìÅ");
      showSyncStatus('Database inizializzato con prodotti di test', 'success');
    } else {
      console.log("‚úÖ Êï∞ÊçÆÂ∫ìÂ∑≤ÊúâÊï∞ÊçÆÔºåÊó†ÈúÄÂàùÂßãÂåñ");
    }
    
  } catch (error) {
    console.error("‚ùå ÂàùÂßãÂåñÂ§±Ë¥•:", error);
    showSyncStatus('Errore nell\'inizializzazione', 'error');
  }
}

async function loadProductsFromFirebase() {
  try {
    showSyncStatus('Caricamento prodotti...', 'syncing');
    
    // ÂÖàÂàùÂßãÂåñÊ£ÄÊü•
    await initializeFirebaseData();
    
    const { collection, getDocs } = window.firebaseModules;
    const querySnapshot = await getDocs(collection(window.firestore, "products"));
    
    const products = [];
    querySnapshot.forEach((doc) => {
      products.push({ id: doc.id, ...doc.data() });
    });
    
    // ‰ΩøÁî® storeProducts ÈÅøÂÖçÂÜ≤Á™Å
    window.storeProducts = products;
    
    // ÈáçÊñ∞Ê∏≤Êüì‰∫ßÂìÅ
    renderProducts();
    updateAdminStats();
    
    showSyncStatus(`Caricati ${products.length} prodotti`, 'success');
    return products;
  } catch (error) {
    console.error("Errore nel caricamento prodotti:", error);
    showSyncStatus('Errore nel caricamento', 'error');
    return [];
  }
}

async function addProductToFirebase(productData) {
  try {
    const { addDoc, collection } = window.firebaseModules;
    const docRef = await addDoc(collection(window.firestore, "products"), productData);
    console.log("Prodotto aggiunto con ID: ", docRef.id);
    return docRef.id;
  } catch (error) {
    console.error("Errore nell'aggiunta prodotto: ", error);
    throw error;
  }
}

// ==================== ‰∫ßÂìÅÂ±ïÁ§∫ ====================
let currentPage = 1; 
const productsPerPage = 8; 
let filteredProducts = [];

const renderProducts = () => {
  const container = document.getElementById('products-container');
  const search = document.getElementById('product-search').value.toLowerCase();
  const category = document.getElementById('category-filter').value;
  
  // ‰ΩøÁî® storeProducts
  filteredProducts = window.storeProducts.filter(p=>
    (p.name.toLowerCase().includes(search)||p.id.includes(search)) &&
    (category==='all'||p.category===category)
  );
  
  const end = currentPage * productsPerPage;
  const html = filteredProducts.slice(0,end).map(p=>{
    const hasDiscount = p.discountPrice && p.originalPrice;
    return `
      <div class="product-card" onclick="openProductModal('${p.id}')">
        <img src="${p.image}" alt="${p.name}" class="product-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW1tYWdpbmUgbm9uIGNhcmljYXRhPC90ZXh0Pjwvc3ZnPg=='">
        ${hasDiscount ? `<div class="discount-badge">-${p.discountPercentage}%</div>` : ''}
        <div class="product-info">
          <div class="product-name">${p.name}</div>
          <div class="product-price-container">
            ${hasDiscount ? 
              `<span class="original-price">${p.originalPrice}</span><span class="discount-price">${p.discountPrice}</span>` : 
              `<span class="discount-price">${p.price}</span>`
            }
          </div>
          <span class="product-category">${getCategoryName(p.category)}</span>
          <div class="product-barcode-small">Codice: ${p.id}</div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
  document.getElementById('load-more').style.display = end < filteredProducts.length ? 'block' : 'none';
};

const getCategoryName = (category) => {
  const categories = {
    'regalo': 'Articoli Regalo',
    'giocattoli': 'Giocattoli',
    'cartoleria': 'Cartoleria',
    'casalinghi': 'Casalinghi',
    'ferramenta': 'Ferramenta',
    'animali': 'Articoli per animali',
    'illuminazione': 'Illuminazione',
    'mobili': 'Mobili',
    'natale': 'Articoli Natalizi'
  };
  return categories[category] || category;
};

// ==================== ‰∫ßÂìÅËØ¶ÊÉÖÂºπÁ™ó ====================
const openProductModal = (productId) => {
  // ‰ΩøÁî® storeProducts
  const product = window.storeProducts.find(p => p.id === productId);
  if (!product) return;
  
  const modal = document.getElementById('privacy-modal');
  document.getElementById('modal-content').innerHTML = `
    <h2 style="color:var(--primary-color)">${product.name}</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1rem">
      <div><img src="${product.image}" alt="${product.name}" style="width:100%;border-radius:8px"></div>
      <div>
        ${product.discountPrice ? 
          `<div><span class="original-price">${product.originalPrice}</span><div class="discount-price">${product.discountPrice}</div></div>` : 
          `<div class="discount-price">${product.price}</div>`
        }
        <p><strong>Codice:</strong> ${product.id}</p>
        ${product.description && product.description !== product.name ? `<p>${product.description}</p>` : ''}
        <div style="margin-top:1rem">
          <button onclick="printProduct('${product.id}')" style="margin-right:0.5rem;background:var(--primary-color);color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer">
            <i class="fas fa-print"></i> Stampa
          </button>
          <button onclick="shareProduct('${product.id}')" style="background:var(--secondary-color);color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer">
            <i class="fas fa-share"></i> Condividi
          </button>
        </div>
      </div>
    </div>
  `;
  modal.style.display = 'flex';
};

const closeModal = () => {
  document.getElementById('privacy-modal').style.display = 'none';
};

const printProduct = (id) => {
  // ‰ΩøÁî® storeProducts
  const p = window.storeProducts.find(x => x.id === id);
  const win = window.open('', '', 'width=600,height=400');
  win.document.write(`
    <html lang="it">
    <head><title>${p.name}</title></head>
    <body style="font-family:Arial,sans-serif;padding:2rem">
      <h2>${p.name}</h2>
      ${p.discountPrice ? 
        `<p><span style="text-decoration:line-through">${p.originalPrice}</span> <strong style="color:#ff6b00;font-size:1.2em">${p.discountPrice}</strong></p>` : 
        `<p><strong style="color:#ff6b00;font-size:1.2em">${p.price}</strong></p>`
      }
      <p>Categoria: ${getCategoryName(p.category)}</p>
      <div class="barcode" style="font-family:monospace;font-size:1.2em;margin:1rem 0">${p.id}</div>
      <p>Porta questo codice in negozio per trovare facilmente il prodotto.</p>
      <button onclick="window.print()" style="background:#004080;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer">Stampa</button>
    </body>
    </html>
  `);
  win.document.close();
};

const shareProduct = (id) => {
  // ‰ΩøÁî® storeProducts
  const p = window.storeProducts.find(x => x.id === id);
  const text = `Scopri ${p.name} da Supershop Bisagno! ${p.discountPrice || p.price}. Visita il negozio!`;
  if (navigator.share) {
    navigator.share({title: p.name, text, url: location.href});
  } else {
    navigator.clipboard.writeText(`${text} ${location.href}`).then(() => alert('Informazioni copiate negli appunti!'));
  }
};

// ==================== ÁÆ°ÁêÜÂëòÂäüËÉΩ ====================
const addProduct = async () => {
  const name = document.getElementById('adminProductName').value.trim();
  const barcode = document.getElementById('adminProductBarcode').value.trim();
  const category = document.getElementById('adminProductCategory').value;
  const original = document.getElementById('adminOriginalPrice').value.trim();
  const discount = document.getElementById('adminDiscountPrice').value.trim();
  const image = document.getElementById('adminProductImage').value.trim();
  const desc = document.getElementById('adminProductDescription').value.trim() || name;
  
  if (!name || !barcode) {
    alert('Nome e barcode obbligatori!');
    return;
  }

  // ‰ΩøÁî® storeProducts Ê£ÄÊü•ÈáçÂ§ç
  if (window.storeProducts.some(p => p.id === barcode)) {
    alert('Barcode gi√† esistente!');
    return;
  }

  // ÊûÑÂª∫‰∫ßÂìÅÊï∞ÊçÆ
  const productData = {
    id: barcode,
    name,
    category,
    image: image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW1tYWdpbmUgbm9uIGNhcmljYXRhPC90ZXh0Pjwvc3ZnPg==',
    description: desc,
    createdAt: new Date().toISOString()
  };

  // ‰ª∑Ê†ºÂ§ÑÁêÜ
  if (original && discount) {
    const orig = parseFloat(original.replace(',','.'));
    const disc = parseFloat(discount.replace(',','.'));
    productData.originalPrice = `‚Ç¨${original}`;
    productData.discountPrice = `‚Ç¨${discount}`;
    productData.discountPercentage = parseFloat(((orig-disc)/orig*100).toFixed(2));
  } else if (original) {
    productData.price = `‚Ç¨${original}`;
  } else if (discount) {
    productData.price = `‚Ç¨${discount}`;
  } else {
    productData.price = 'Prezzo su richiesta';
  }

  try {
    // Ê∑ªÂä†Âà∞ Firebase
    await addProductToFirebase(productData);
    
    // ÈáçÊñ∞Âä†ËΩΩ‰∫ßÂìÅÂàóË°®
    await loadProductsFromFirebase();
    
    // Ê∏ÖÁ©∫Ë°®Âçï
    document.getElementById('adminProductName').value = '';
    document.getElementById('adminProductBarcode').value = '';
    document.getElementById('adminOriginalPrice').value = '';
    document.getElementById('adminDiscountPrice').value = '';
    document.getElementById('adminProductImage').value = '';
    document.getElementById('adminProductDescription').value = '';
    
    alert('‚úÖ Prodotto aggiunto con successo al database cloud!');
  } catch (error) {
    alert('‚ùå Errore nell\'aggiunta del prodotto: ' + error.message);
  }
};

// ÂÖ∂‰ΩôÁÆ°ÁêÜÂëòÂáΩÊï∞‰πüÈúÄË¶ÅÊõ¥Êñ∞...
const updateAdminStats = () => {
  // ‰ΩøÁî® storeProducts
  document.getElementById('totalProducts').textContent = window.storeProducts.length;
  const categories = new Set(window.storeProducts.map(p => p.category));
  document.getElementById('totalCategories').textContent = categories.size;
};

// ÂÖ∂‰ªñÂáΩÊï∞Â¶Ç exportProducts, importProducts Á≠â‰πüÈúÄË¶ÅÁ±ª‰ººÊõ¥Êñ∞...

// ==================== È°µÈù¢ÂàùÂßãÂåñ ====================
document.addEventListener('DOMContentLoaded', async () => {
  document.getElementById('year').textContent = new Date().getFullYear();
  document.getElementById('hiddenAdminBtn').style.display = 'block';
  
  // ÂàùÂßãÂåñ storeProducts
  window.storeProducts = [];
  
  // Á≠âÂæÖ Firebase ÂàùÂßãÂåñÂÆåÊàêÂêéÂä†ËΩΩ‰∫ßÂìÅ
  setTimeout(async () => {
    console.log("üîÑ ÂºÄÂßãÂä†ËΩΩ Firebase Êï∞ÊçÆ...");
    await loadProductsFromFirebase();
  }, 1000);
  
  // ÂÖ∂‰Ωô‰∫ã‰ª∂ÁõëÂê¨Âô®‰øùÊåÅ‰∏çÂèò
  document.getElementById('product-search').addEventListener('input', () => {
    currentPage = 1;
    renderProducts();
  });
  
  document.getElementById('category-filter').addEventListener('change', () => {
    currentPage = 1;
    renderProducts();
  });
  
  document.getElementById('load-more').addEventListener('click', () => {
    currentPage++;
    renderProducts();
  });
  
  document.getElementById('hiddenAdminBtn').addEventListener('click', enableAdminPanel);
  document.getElementById('adminBtn').addEventListener('click', enableAdminPanel);
  
  document.querySelector('.mobile-menu-btn').addEventListener('click', () => {
    const nav = document.getElementById('navMenu');
    nav.style.display = nav.style.display === 'flex' ? 'none' : 'flex';
  });
  
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'm') {
      e.preventDefault();
      enableAdminPanel();
    }
  });
  
  const backToTop = document.getElementById('backToTop');
  window.addEventListener('scroll', () => {
    backToTop.classList.toggle('visible', window.pageYOffset > 300);
  });
  
  backToTop.addEventListener('click', e => {
    e.preventDefault();
    window.scrollTo({top: 0, behavior: 'smooth'});
  });
});

// Âº∫Âà∂Âà∑Êñ∞ÂáΩÊï∞ÔºàÊµãËØïÁî®Ôºâ
function forceRefresh() {
  console.log("üîÑ Âº∫Âà∂Âà∑Êñ∞...");
  console.log("storeProducts:", window.storeProducts);
  if (window.storeProducts && window.storeProducts.length > 0) {
    renderProducts();
    updateAdminStats();
  } else {
    loadProductsFromFirebase();
  }
}

// 5ÁßíÂêéÂº∫Âà∂Âà∑Êñ∞‰∏ÄÊ¨°ÔºàÁ°Æ‰øùÊï∞ÊçÆÊòæÁ§∫Ôºâ
setTimeout(forceRefresh, 5000);
</script>
</body>
</html>
